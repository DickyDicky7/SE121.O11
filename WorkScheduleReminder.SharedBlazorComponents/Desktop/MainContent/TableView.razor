@using WorkScheduleReminder.SharedBlazorComponents.Desktop.PopupAndSubMenus
@page "/table"
<MudPaper Class="pa-2"
          Style="background-color:transparent; overflow:hidden;"
          Elevation="0"
          Width="100%"
          Height="100%">
    @*Editing (OK),
    grouping (OK),
    sorting (alphabetically(OK)),
    resizing (OK),
    column re-ordering (?),
    row hidden (toggle by switch(OK)),
    filtering (by default toolbar(?))*@
    <MudDataGrid Style="height:100%; overflow-x:scroll;overflow-y:hidden;"
                 T="Task"
                 Items="Tasks"
                 Height="100%"
                 FixedHeader="true"
                 Virtualize="true"
                 Groupable="true"
                 SortMode="SortMode.Multiple"
                 ColumnResizeMode="ResizeMode.Column"
                 DragDropColumnReordering="true"
                 DragIndicatorIcon="@Icons.Material.Filled.DragIndicator"
                 ApplyDropClassesOnDragStarted="true">
        <ToolBarContent>
            <MudPaper Class="d-flex flex-row gap-2 py-3 align-center"
                      Elevation="0"
                      Width="100%">
                <MudSwitch @bind-Checked="@ColumnsVisibility[0]"
                           Size="Size.Small"
                           Label="Title"
                           Color="Color.Success" />
                <MudSwitch @bind-Checked="@ColumnsVisibility[1]"
                           Size="Size.Small"
                           Label="Tag"
                           Color="Color.Success" />
                <MudSwitch @bind-Checked="@ColumnsVisibility[2]"
                           Size="Size.Small"
                           Label="Assignees"
                           Color="Color.Success" />
                <MudSwitch @bind-Checked="@ColumnsVisibility[3]"
                           Size="Size.Small"
                           Label="DueDay"
                           Color="Color.Success" />
                <MudTextField @bind-Value=@NewTask
                              Placeholder="+ Add task"
                              Immediate="true"
                              DisableUnderLine="true"
                              FullWidth="true"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Clearable="true"
                              TextUpdateSuppression="false"
                              OnKeyDown="((KeyboardEventArgs e)=>OnKeyDown(e))" />
            </MudPaper>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x=>x.Title"
                            Hidden="@(!ColumnsVisibility[0])"
                            StickyLeft="true"
                            Groupable="false" />
            <PropertyColumn Property="x=>x.Tag"
                            Hidden="@(!ColumnsVisibility[1])" />
            <PropertyColumn Property="x=>x.Assignees"
                            Hidden="@(!ColumnsVisibility[2])" />
            <PropertyColumn Property="x=>x.DueDay"
                            Hidden="@(!ColumnsVisibility[3])" />
            <TemplateColumn StickyRight="true"
                            Groupable="false"
                            Sortable="false">
                <CellTemplate>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                   Size="Size.Small"
                                   OnClick="(()=>OnEditButtonClick(context.Item.Title))" />
                </CellTemplate>
            </TemplateColumn>
        </Columns>
        <NoRecordsContent>
            <MudText>There's nothing here :(</MudText>
        </NoRecordsContent>
        <LoadingContent>
            <MudText>Loading...</MudText>
        </LoadingContent>
    </MudDataGrid>
</MudPaper>
<MudOverlay Visible="@TaskDetailVisible"
            DarkBackground="true"
            AutoClose="true"
            OnClick="(()=>{TaskDetailVisible=!TaskDetailVisible;})">
    <TaskDetail @onclick:stopPropagation
                Title="@CurrentTitle" />
</MudOverlay>

@code {
    public string NewTask { get; set; } = string.Empty;
    public bool[] ColumnsVisibility = new bool[5] { true, true, true, true, true };
    public bool TaskDetailVisible { get; set; } = false;
    public string CurrentTitle { get; set; } = string.Empty;
    public record Task(string Title, string Tag, int Assignees, DateTime DueDay);
    public IEnumerable<Task> Tasks = null!;
    public List<Task> Temp = new List<Task>();
    protected override async System.Threading.Tasks.Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        foreach (int i in Enumerable.Range(0, 30))
        {
            //Temp.Add(new Task(i.ToString(), (30 - i).ToString(), 45 - i, DateTime.Now.AddDays(i)));
        }
        Tasks = Temp;
    }
    public void OnEditButtonClick(string TaskTitle)
    {
        TaskDetailVisible = !TaskDetailVisible;
        CurrentTitle = TaskTitle;
    }
    public void OnKeyDown(KeyboardEventArgs keyboardEvent)
    {
        if (keyboardEvent.Code == "Enter" && NewTask != string.Empty)
        {
            Temp.Add(new Task(NewTask, "hehe", 666, DateTime.Now));
            NewTask = string.Empty;
            StateHasChanged();
        }
    }
}
